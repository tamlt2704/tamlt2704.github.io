<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>snake game phaser</title>
</head>
<body>
    <div id="root"> </div>
    <script src="phaser.min.js"> </script>
    <script>
        const gameWidth = 640;
        const gameHeight = 480;
        function beep() {
            var snd = new  Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");
            snd.play();
        }

        class Menu extends Phaser.Scene {
            constructor() {
                super({key: 'Menu'})
            }

            preload() {
            }

            create() {
                this.text = this.add.text(gameWidth / 2 - 150, gameHeight / 2 , "Phaser.io",
                    {font: "60px Impact"});

                this.input.keyboard.on('keyup', (e) => {
                    console.log(e.key)
                    if (e.key == "a") {
                        this.scene.start("Game")
                    }
                })

                this.graphics = this.add.graphics()
                this.graphics.setDefaultStyles({
                        lineStyle: {
                                    width: 1,
                                    color: 0xffffff,
                                    alpha: 1
                                },
                        fillStyle: {
                                    color: 0xffffff,
                                    alpha: 1
                                }
                });

                this.stars = [];
                for (let i = 0; i < 100; i ++) {
                    this.stars.push({
                        x: Math.random() * gameWidth,
                        y: Math.random() * gameHeight,
                        radius: Math.random() * 10,
                        alpha: Math.random()
                    })
                }
            }

            update(delta) {
                this.graphics.clear()
                for (let star of this.stars) {
                    star.radius += 0.001;
                    if (star.radius >= 5) {
                        star.radius = Math.random() * 10
                        star.x = Math.random() * gameWidth
                        star.y = Math.random() * gameHeight
                        star.alpha =  Math.random()
                    }
                    this.graphics.fillStyle(0xffffff, star.alpha * 0.5)
                    this.graphics.fillCircle(star.x, star.y, star.radius)
                }
            }
        }
        
        var snake;
        var cursors;
        var food;
        var soundStart;
        var soundEating;
        var soundDie;


        var UP = 0,
            DOWN = 1,
            LEFT = 2,
            RIGHT = 3;

        class Game extends Phaser.Scene {
            constructor() {
                super({key: 'Game'})
            }
            
            preload() {
                // add black border to the body
                //convert snake_16_16.jpg -stroke black -strokewidth 1 -fill none -draw "rectangle 0,0,15,15" body_border.jpg
                this.load.image('body', 'assets/snakephaser/body_border.jpg')
                //conver -size 16x16 xc:red food.jpg
                this.load.image('food', 'assets/snakephaser/food.jpg')

                this.load.audio('start', 'assets/snakephaser/start.mp3')
                this.load.audio('eating', 'assets/snakephaser/eating2.mp3')
                this.load.audio('die', 'assets/snakephaser/die.mp3')

            }

            create() {
                soundStart = this.sound.add('start')
                soundEating = this.sound.add('eating')
                soundDie = this.sound.add('die')
                soundStart.play()

                var Food = new Phaser.Class({
                    Extends: Phaser.GameObjects.Image,
                    initialize: function Food(scene, x, y) {
                        Phaser.GameObjects.Image.call(this, scene)

                        this.setTexture('food')
                        this.setPosition(x*16, y*16)
                        this.setOrigin(0)
                        this.total = 0
                        scene.children.add(this)
                    },
                    eat: function() {
                        this.total++;
                        soundEating.play();
                        var x = Phaser.Math.Between(0, 39)
                        var y = Phaser.Math.Between(0, 29)
                        this.setPosition(x * 16, y * 16)
                    }
                })
                var Snake = new Phaser.Class({
                    initialize: function Snake(scene, x, y) {
                        this.headPosition = new Phaser.Geom.Point(x, y)
                        this.body = scene.add.group()
                        this.head = this.body.create(x*16, y * 16, 'body')
                        this.head.setOrigin(0)
                        this.alive = true
                        this.speed = 100
                        this.moveTime = 0
                        this.heading = RIGHT
                        this.direction = RIGHT

                        this.tail = new Phaser.Geom.Point(x, y)
                    },
                    update: function(time) {
                        console.log(`snake update ${time}`)
                    },
                    update: function(time) {
                        if (time >= this.moveTime) {
                            return this.move(time)
                        }
                    },
                    faceLeft: function() {
                        if (this.direction === UP || this.direction === DOWN) {
                            this.heading = LEFT
                        }
                    },
                    faceRight: function() {
                        if (this.direction === UP || this.direction === DOWN) {
                            this.heading = RIGHT 
                        }
                    },
                    faceUp: function() {
                        if (this.direction === LEFT || this.direction === RIGHT) {
                            this.heading = UP 
                        }
                    },
                    faceDown: function() {
                        if (this.direction === LEFT || this.direction === RIGHT) {
                            this.heading = DOWN
                        }
                    },
                    move: function(time) {
                        switch(this.heading) {
                            case LEFT:
                                this.headPosition.x = Phaser.Math.Wrap(this.headPosition.x - 1, 0, 40)
                                break
                            case RIGHT:
                                this.headPosition.x = Phaser.Math.Wrap(this.headPosition.x + 1, 0, 40)
                                break
                            case UP:
                                this.headPosition.y = Phaser.Math.Wrap(this.headPosition.y - 1, 0, 30)
                                break
                            case DOWN:
                                this.headPosition.y = Phaser.Math.Wrap(this.headPosition.y + 1, 0, 30)
                                break
                        }
                        this.direction = this.heading

                        //update body segments
                        Phaser.Actions.ShiftPosition(this.body.getChildren(), this.headPosition.x * 16, this.headPosition.y * 16, 1)

                        var hitBody = Phaser.Actions.GetFirst(this.body.getChildren(), {x: this.head.x, y: this.head.y}, 1)
                        
                        if (hitBody) {
                            console.log('dead')
                            this.alive = false
                            soundDie.play()
                            return false
                        }
                        this.moveTime = time + this.speed

                        return true
                    },
                    grow: function() {
                        var newPart = this.body.create(this.tail.x, this.tail.y, 'body')
                        newPart.setOrigin(0)
                    },
                    collideWithFood: function(food) {
                        if (this.head.x === food.x && this.head.y === food.y) {
                            this.grow()
                            food.eat()

                            if (this.speed > 20 && food.total % 5 == 0) {
                                console.log('increase speed',this.speed)
                                this.speed -= 5
                            }
                            return true
                        } else {
                            return false
                        }
                    },
                    updateGrid: function(grid) {
                        this.body.children.each(function(segment) {
                            var bx = segment.x / 16
                            var by = segment.y / 16
                            grid[by][bx] = false
                        })
                        return grid;
                    }
                })

                snake = new Snake(this, 8, 5)
                food = new Food(this, 3, 4)
                cursors = this.input.keyboard.createCursorKeys()
            }

            update(time) {

                if (!snake.alive) {
                    return;
                }

                if (cursors.left.isDown) {
                    snake.faceLeft()
                } else if (cursors.right.isDown) {
                    snake.faceRight()
                } else if (cursors.up.isDown) {
                    snake.faceUp()
                } else if (cursors.down.isDown) {
                    snake.faceDown()
                }

                if (snake.update(time)) {
                    if (snake.collideWithFood(food)) {
                        repositionFood()
                    }
                }
            }
        }
        
        function repositionFood() {
            var testGrid = []
            for (let y = 0; y < 30; y++) {
                testGrid[y] = []
                for (let x = 0; x < 40; x++) {
                    testGrid[y][x] = true
                }
            }

            var validLocations = []
            for (let y = 0; y < 30; y++) {
                for (let x = 0; x < 40; x++) {
                    if (testGrid[y][x] == true) {
                        validLocations.push({x, y})
                    }
                }
            }

            if (validLocations.length > 0) {
                var pos = Phaser.Math.RND.pick(validLocations)
                console.log('new food position', pos.x, pos.y)
                food.setPosition(pos.x * 16, pos.y * 16)
                return true
            } else {
                return false
            }
        }
        const config = {
            type: Phaser.AUTO,
            width: gameWidth,
            height: gameHeight,
            //backgroundColor: '#bfcc00',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y : 200 }
                }
            },
            scene: [ Game, Menu]
        }

        
        const game = new Phaser.Game(config)
    </script>
</body>
</html>
