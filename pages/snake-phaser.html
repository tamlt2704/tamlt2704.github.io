<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>snake game phaser</title>
</head>
<body>
    <div id="root"> </div>
    <script src="phaser.min.js"> </script>
    <script>
        const gameWidth = 640;
        const gameHeight = 480;

        class Menu extends Phaser.Scene {
            constructor() {
                super({key: 'Menu'})
            }

            preload() {
            }

            create() {
                this.text = this.add.text(gameWidth / 2 - 150, gameHeight / 2 , "Phaser.io",
                    {font: "60px Impact"});

                this.input.keyboard.on('keyup', (e) => {
                    console.log(e.key)
                    if (e.key == "a") {
                        this.scene.start("Game")
                    }
                })

                this.graphics = this.add.graphics()
                this.graphics.setDefaultStyles({
                        lineStyle: {
                                    width: 1,
                                    color: 0xffffff,
                                    alpha: 1
                                },
                        fillStyle: {
                                    color: 0xffffff,
                                    alpha: 1
                                }
                });

                this.stars = [];
                for (let i = 0; i < 100; i ++) {
                    this.stars.push({
                        x: Math.random() * gameWidth,
                        y: Math.random() * gameHeight,
                        radius: Math.random() * 10,
                        alpha: Math.random()
                    })
                }
            }

            update(delta) {
                this.graphics.clear()
                for (let star of this.stars) {
                    star.radius += 0.001;
                    if (star.radius >= 5) {
                        star.radius = Math.random() * 10
                        star.x = Math.random() * gameWidth
                        star.y = Math.random() * gameHeight
                        star.alpha =  Math.random()
                    }
                    this.graphics.fillStyle(0xffffff, star.alpha * 0.5)
                    this.graphics.fillCircle(star.x, star.y, star.radius)
                }
            }
        }
        
        var snake;
        var cursors;
        var food;

        var UP = 0,
            DOWN = 1,
            LEFT = 2,
            RIGHT = 3;

        class Game extends Phaser.Scene {
            constructor() {
                super({key: 'Game'})
            }
            
            preload() {
                // add black border to the body
                //convert snake_16_16.jpg -stroke black -strokewidth 1 -fill none -draw "rectangle 0,0,15,15" body_border.jpg
                this.load.image('body', 'assets/snakephaser/body_border.jpg')
                //conver -size 16x16 xc:red food.jpg
                this.load.image('food', 'assets/snakephaser/food.jpg')
            }

            create() {
                var Food = new Phaser.Class({
                    Extends: Phaser.GameObjects.Image,
                    initialize: function Food(scene, x, y) {
                        Phaser.GameObjects.Image.call(this, scene)

                        this.setTexture('food')
                        this.setPosition(x*16, y*16)
                        this.setOrigin(0)
                        this.total = 0
                        scene.children.add(this)
                    },
                    eat: function() {
                        this.total++;

                        var x = Phaser.Math.Between(0, 39)
                        var y = Phaser.Math.Between(0, 29)
                        this.setPosition(x * 16, y * 16)
                    }
                })
                var Snake = new Phaser.Class({
                    initialize: function Snake(scene, x, y) {
                        this.headPosition = new Phaser.Geom.Point(x, y)
                        this.body = scene.add.group()
                        this.head = this.body.create(x*16, y * 16, 'body')
                        this.head.setOrigin(0)
                        this.alive = true
                        this.speed = 100
                        this.moveTime = 0
                        this.heading = RIGHT
                        this.direction = RIGHT

                        this.tail = new Phaser.Geom.Point(x, y)
                    },
                    update: function(time) {
                        console.log(`snake update ${time}`)
                    },
                    update: function(time) {
                        if (time >= this.moveTime) {
                            return this.move(time)
                        }
                    },
                    faceLeft: function() {
                        if (this.direction === UP || this.direction === DOWN) {
                            this.heading = LEFT
                        }
                    },
                    faceRight: function() {
                        if (this.direction === UP || this.direction === DOWN) {
                            this.heading = RIGHT 
                        }
                    },
                    faceUp: function() {
                        if (this.direction === LEFT || this.direction === RIGHT) {
                            this.heading = UP 
                        }
                    },
                    faceDown: function() {
                        if (this.direction === LEFT || this.direction === RIGHT) {
                            this.heading = DOWN
                        }
                    },
                    move: function(time) {
                        switch(this.heading) {
                            case LEFT:
                                this.headPosition.x = Phaser.Math.Wrap(this.headPosition.x - 1, 0, 40)
                                break
                            case RIGHT:
                                this.headPosition.x = Phaser.Math.Wrap(this.headPosition.x + 1, 0, 40)
                                break
                            case UP:
                                this.headPosition.y = Phaser.Math.Wrap(this.headPosition.y - 1, 0, 30)
                                break
                            case DOWN:
                                this.headPosition.y = Phaser.Math.Wrap(this.headPosition.y + 1, 0, 30)
                                break
                        }
                        this.direction = this.heading

                        //update body segments
                        Phaser.Actions.ShiftPosition(this.body.getChildren(), this.headPosition.x * 16, this.headPosition.y * 16, 1)

                        this.moveTime = time + this.speed

                        return true
                    },
                    grow: function() {
                        var newPart = this.body.create(this.tail.x, this.tail.y, 'body')
                        newPart.setOrigin(0)
                    },
                    collideWithFood: function(food) {
                        if (this.head.x === food.x && this.head.y === food.y) {
                            this.grow()
                            food.eat()

                            if (this.speed > 20 && food.total % 5 == 0) {
                                console.log('increase speed',this.speed)
                                this.speed -= 5
                            }
                            return true
                        } else {
                            return false
                        }
                    }
                })

                snake = new Snake(this, 8, 8)
                food = new Food(this, 3, 4)
                cursors = this.input.keyboard.createCursorKeys()
            }

            update(time) {

                if (!snake.alive) {
                    return;
                }

                if (cursors.left.isDown) {
                    snake.faceLeft()
                } else if (cursors.right.isDown) {
                    snake.faceRight()
                } else if (cursors.up.isDown) {
                    snake.faceUp()
                } else if (cursors.down.isDown) {
                    snake.faceDown()
                }

                if (snake.update(time)) {
                    snake.collideWithFood(food)
                }
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: gameWidth,
            height: gameHeight,
            //backgroundColor: '#bfcc00',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y : 200 }
                }
            },
            scene: [ Game, Menu]
        }


        const game = new Phaser.Game(config)
    </script>
</body>
</html>
